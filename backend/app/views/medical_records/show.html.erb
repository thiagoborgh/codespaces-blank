<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário: <%= @patient.name %> - Sistema de Saúde</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <style>
        <%= render 'medical_record_styles' %>
    </style>
</head>
<body x-data="medicalRecord()" class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 fixed-top">
        <div class="container-fluid px-4 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button onclick="window.history.back()" class="btn btn-outline-primary me-3">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                    <div>
                        <h1 class="h4 mb-0 text-gray-800">Prontuário Eletrônico</h1>
                        <small class="text-gray-600">Pasta completa do paciente</small>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <% if @active_consultation %>
                        <span class="badge bg-success px-3 py-2">
                            <i class="bi bi-activity"></i> Atendimento em andamento
                        </span>
                    <% end %>
                    <div class="text-end">
                        <div class="fw-medium"><%= current_user&.name || 'Profissional' %></div>
                        <small class="text-gray-600"><%= current_user&.registration_number %></small>
                    </div>
                    <img src="https://via.placeholder.com/40" alt="Profissional" class="rounded-circle" width="40" height="40">
                </div>
            </div>
        </div>
    </header>

    <!-- Patient Header -->
    <div class="patient-header bg-white shadow-sm" style="margin-top: 80px;">
        <div class="container-fluid px-4 py-4">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <div class="patient-avatar">
                        <img src="https://via.placeholder.com/120" alt="<%= @patient.name %>" class="rounded-circle" width="120" height="120">
                        <div class="patient-status active"></div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="patient-info">
                        <h2 class="patient-name"><%= @patient.name %></h2>
                        <div class="patient-details">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="bi bi-person-badge"></i>
                                        <span>CPF: <%= format_cpf(@patient.cpf) %></span>
                                    </div>
                                    <div class="info-item">
                                        <i class="bi bi-calendar"></i>
                                        <span>Nascimento: <%= format_date(@patient.birth_date) %></span>
                                    </div>
                                    <div class="info-item">
                                        <i class="bi bi-clock"></i>
                                        <span>Idade: <%= calculate_age(@patient.birth_date) %> anos</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="bi bi-telephone"></i>
                                        <span>Telefone: <%= format_phone(@patient.phone) %></span>
                                    </div>
                                    <div class="info-item">
                                        <i class="bi bi-geo-alt"></i>
                                        <span>Endereço: <%= @patient.street %>, <%= @patient.number %></span>
                                    </div>
                                    <div class="info-item">
                                        <i class="bi bi-building"></i>
                                        <span>Bairro: <%= @patient.neighborhood %></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alertas e Condições -->
                        <div class="patient-alerts mt-3">
                            <% if @problems.any? %>
                                <div class="alert-section">
                                    <strong>Condições Ativas:</strong>
                                    <% @problems.each do |problem| %>
                                        <span class="badge bg-info me-2">
                                            <i class="bi bi-heart-pulse"></i>
                                            <%= problem.name %>
                                        </span>
                                    <% end %>
                                </div>
                            <% end %>
                            
                            <% if @allergies.any? %>
                                <div class="alert-section">
                                    <strong>Alergias:</strong>
                                    <% @allergies.each do |allergy| %>
                                        <span class="badge bg-warning me-2">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            <%= allergy.substance %>
                                        </span>
                                    <% end %>
                                </div>
                            <% end %>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="quick-actions">
                        <% if @active_consultation %>
                            <button class="btn btn-primary btn-lg w-100 mb-2" @click="activeTab = 'soap'">
                                <i class="bi bi-clipboard-pulse"></i>
                                Continuar Atendimento
                            </button>
                        <% else %>
                            <button class="btn btn-success btn-lg w-100 mb-2" 
                                    onclick="document.getElementById('startConsultationModal').style.display = 'block'">
                                <i class="bi bi-play-circle"></i>
                                Iniciar Atendimento
                            </button>
                        <% end %>
                        
                        <button class="btn btn-outline-primary w-100 mb-2" @click="activeTab = 'appointments'">
                            <i class="bi bi-calendar-plus"></i>
                            Agendar Consulta
                        </button>
                        
                        <button class="btn btn-outline-secondary w-100" @click="activeTab = 'documents'">
                            <i class="bi bi-file-earmark-medical"></i>
                            Documentos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid px-4 py-4">
        <div class="row">
            <!-- Navigation Tabs -->
            <div class="col-12 mb-4">
                <div class="nav-tabs-wrapper">
                    <ul class="nav nav-tabs nav-fill" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    :class="{ 'active': activeTab === 'overview' }"
                                    @click="activeTab = 'overview'">
                                <i class="bi bi-house"></i>
                                Visão Geral
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    :class="{ 'active': activeTab === 'soap' }"
                                    @click="activeTab = 'soap'">
                                <i class="bi bi-clipboard-pulse"></i>
                                SOAP
                                <% if @active_consultation %>
                                    <span class="badge bg-success ms-2">Ativo</span>
                                <% end %>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    :class="{ 'active': activeTab === 'history' }"
                                    @click="activeTab = 'history'">
                                <i class="bi bi-clock-history"></i>
                                Histórico
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    :class="{ 'active': activeTab === 'prescriptions' }"
                                    @click="activeTab = 'prescriptions'">
                                <i class="bi bi-prescription2"></i>
                                Prescrições
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    :class="{ 'active': activeTab === 'exams' }"
                                    @click="activeTab = 'exams'">
                                <i class="bi bi-file-earmark-medical"></i>
                                Exames
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    :class="{ 'active': activeTab === 'appointments' }"
                                    @click="activeTab = 'appointments'">
                                <i class="bi bi-calendar-check"></i>
                                Agendamentos
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    :class="{ 'active': activeTab === 'documents' }"
                                    @click="activeTab = 'documents'">
                                <i class="bi bi-folder"></i>
                                Documentos
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Content Area -->
            <div class="col-md-9">
                <div class="tab-content">
                    <!-- Visão Geral -->
                    <div x-show="activeTab === 'overview'" class="tab-pane">
                        <%= render 'overview_tab' %>
                    </div>

                    <!-- SOAP -->
                    <div x-show="activeTab === 'soap'" class="tab-pane">
                        <% if @active_consultation %>
                            <%= render 'soap_tab' %>
                        <% else %>
                            <%= render 'soap_inactive' %>
                        <% end %>
                    </div>

                    <!-- Histórico -->
                    <div x-show="activeTab === 'history'" class="tab-pane">
                        <%= render 'history_tab' %>
                    </div>

                    <!-- Prescrições -->
                    <div x-show="activeTab === 'prescriptions'" class="tab-pane">
                        <%= render 'prescriptions_tab' %>
                    </div>

                    <!-- Exames -->
                    <div x-show="activeTab === 'exams'" class="tab-pane">
                        <%= render 'exams_tab' %>
                    </div>

                    <!-- Agendamentos -->
                    <div x-show="activeTab === 'appointments'" class="tab-pane">
                        <%= render 'appointments_tab' %>
                    </div>

                    <!-- Documentos -->
                    <div x-show="activeTab === 'documents'" class="tab-pane">
                        <%= render 'documents_tab' %>
                    </div>
                </div>
            </div>

            <!-- Sidebar - Timeline -->
            <div class="col-md-3">
                <div class="card sticky-top" style="top: 200px;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i>
                            Timeline Completa
                        </h5>
                    </div>
                    <div class="card-body timeline-container">
                        <div class="timeline">
                            <% @timeline_events.each do |event| %>
                                <div class="timeline-item">
                                    <div class="timeline-marker <%= event[:badge_class] %>">
                                        <i class="bi bi-<%= event[:icon] %>"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-date">
                                            <%= time_ago_in_words(event[:date]) %> atrás
                                        </div>
                                        <div class="timeline-title"><%= event[:title] %></div>
                                        <% if event[:description].present? %>
                                            <div class="timeline-description"><%= event[:description] %></div>
                                        <% end %>
                                        <% if event[:professional].present? %>
                                            <div class="timeline-professional">
                                                <i class="bi bi-person"></i>
                                                <%= event[:professional] %>
                                            </div>
                                        <% end %>
                                    </div>
                                </div>
                            <% end %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Iniciar Consulta -->
    <div id="startConsultationModal" class="modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Iniciar Atendimento</h5>
                    <button type="button" class="btn-close" onclick="document.getElementById('startConsultationModal').style.display = 'none'"></button>
                </div>
                <form action="<%= create_consultation_medical_record_path(@patient) %>" method="post">
                    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Consulta</label>
                            <select name="consultation[consultation_type]" class="form-select" required>
                                <option value="">Selecione o tipo</option>
                                <option value="routine">Consulta de Rotina</option>
                                <option value="emergency">Atendimento de Emergência</option>
                                <option value="follow_up">Retorno/Acompanhamento</option>
                                <option value="specialist">Consulta Especializada</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações Iniciais</label>
                            <textarea name="consultation[description]" class="form-control" rows="3" 
                                      placeholder="Motivo da consulta ou observações iniciais..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('startConsultationModal').style.display = 'none'">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-play-circle"></i>
                            Iniciar Atendimento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        <%= render 'medical_record_javascript' %>
    </script>
    
    <!-- Gráficos e funcionalidades da folha rosto -->
    <%= render 'folha_rosto_charts' %>
</body>
</html>
